{% extends 'trainer/base.html' %}

{% block title %}Practice - Mental Math Trainer{% endblock %}

{% block extra_css %}
<style>
    .question-display {
        font-size: 48px;
        font-weight: bold;
        text-align: center;
        padding: 40px 20px;
        margin-bottom: 30px;
    }

    .answer-section {
        text-align: center;
    }

    #answer-input {
        max-width: 300px;
        margin: 0 auto 20px;
    }

    .result-message {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
        min-height: 40px;
    }

    .timer {
        font-size: 18px;
        color: #9ca3af;
        margin-bottom: 20px;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .streak-display {
        text-align: center;
        margin-bottom: 20px;
        font-size: 14px;
        color: #9ca3af;
    }

    .streak-count {
        font-size: 24px;
        font-weight: bold;
        color: #fbbf24;
    }

    .keyboard-hint {
        font-size: 12px;
        color: #6b7280;
        margin-top: 10px;
    }

    .leitner-info {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .leitner-box-display {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.05);
        padding: 8px 16px;
        border-radius: 8px;
    }

    .box-indicator {
        display: flex;
        gap: 4px;
    }

    .box-dot {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.1);
    }

    .box-dot.active {
        background: #4a90d9;
    }

    .box-dot.box-1.active { background: #ef4444; }
    .box-dot.box-2.active { background: #f97316; }
    .box-dot.box-3.active { background: #eab308; }
    .box-dot.box-4.active { background: #22c55e; }
    .box-dot.box-5.active { background: #14b8a6; }

    .due-count {
        font-size: 14px;
        color: #9ca3af;
    }

    .due-count .count {
        font-weight: bold;
        color: #fbbf24;
    }

    .box-distribution {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 10px;
        font-size: 12px;
    }

    .box-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 5px 10px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 5px;
    }

    .box-stat .box-label {
        color: #6b7280;
        font-size: 10px;
    }

    .box-stat .box-count {
        font-weight: bold;
    }

    .box-stat.box-1 .box-count { color: #ef4444; }
    .box-stat.box-2 .box-count { color: #f97316; }
    .box-stat.box-3 .box-count { color: #eab308; }
    .box-stat.box-4 .box-count { color: #22c55e; }
    .box-stat.box-5 .box-count { color: #14b8a6; }

    .leitner-result {
        font-size: 14px;
        color: #9ca3af;
        margin-top: 8px;
    }

    .box-change {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: bold;
    }

    .box-change.promoted {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    .box-change.demoted {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="filters">
        <select id="difficulty-select">
            <option value="">All Difficulty Levels</option>
            {% for value, name in difficulty_levels %}
            <option value="{{ value }}" {% if selected_difficulty == value %}selected{% endif %}>
                Level {{ value }}: {{ name }}
            </option>
            {% endfor %}
        </select>
        <select id="operation-select">
            <option value="">All Operations</option>
            {% for value, name in operation_types %}
            <option value="{{ value }}" {% if selected_operation == value %}selected{% endif %}>
                {{ name }}
            </option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="card">
    <div class="streak-display">
        Current Streak: <span class="streak-count" id="streak">{{ current_user.current_streak }}</span>
        <span style="margin-left: 20px; font-size: 12px;">Best: <span id="best-streak">{{ current_user.best_streak }}</span></span>
    </div>

    <div class="leitner-info">
        <div class="leitner-box-display">
            <span>Box:</span>
            <div class="box-indicator">
                {% for i in "12345" %}
                <div class="box-dot box-{{ i }} {% if current_card.box_number == i|add:0 %}active{% endif %}" title="Box {{ i }}"></div>
                {% endfor %}
            </div>
            <span id="current-box">{{ current_card.box_number }}</span>
        </div>
        <div class="due-count">
            Due for review: <span class="count" id="due-count">{{ due_count }}</span>
        </div>
    </div>

    <div class="box-distribution">
        {% for box_num, count in box_distribution.items %}
        <div class="box-stat box-{{ box_num }}">
            <span class="box-count">{{ count }}</span>
            <span class="box-label">Box {{ box_num }}</span>
        </div>
        {% endfor %}
    </div>

    <div class="question-display" id="question">
        {{ question.question_text }}
    </div>

    <div class="answer-section">
        <div class="timer" id="timer">0.0s</div>

        <input type="text"
               id="answer-input"
               autocomplete="off"
               inputmode="decimal"
               placeholder="Enter your answer"
               autofocus>

        <div class="result-message" id="result"></div>
        <div class="leitner-result" id="leitner-result"></div>

        <div class="action-buttons">
            <button id="submit-btn" class="btn-primary">Check Answer</button>
            <button id="next-btn" class="btn-secondary" style="display: none;">Next Question</button>
            <button id="skip-btn" class="btn-secondary">Skip</button>
        </div>

        <p class="keyboard-hint">Press Enter to submit, or press Enter again for next question</p>
    </div>
</div>

<input type="hidden" id="question-id" value="{{ question.id }}">
<input type="hidden" id="csrf-token" value="{{ csrf_token }}">
{% endblock %}

{% block extra_js %}
<script>
    const questionId = document.getElementById('question-id').value;
    const csrfToken = document.getElementById('csrf-token').value;
    const answerInput = document.getElementById('answer-input');
    const submitBtn = document.getElementById('submit-btn');
    const nextBtn = document.getElementById('next-btn');
    const skipBtn = document.getElementById('skip-btn');
    const resultDiv = document.getElementById('result');
    const leitnerResultDiv = document.getElementById('leitner-result');
    const timerDiv = document.getElementById('timer');
    const streakSpan = document.getElementById('streak');
    const bestStreakSpan = document.getElementById('best-streak');
    const currentBoxSpan = document.getElementById('current-box');
    const difficultySelect = document.getElementById('difficulty-select');
    const operationSelect = document.getElementById('operation-select');
    const initialBox = {{ current_card.box_number }};

    let startTime = Date.now();
    let timerInterval;
    let answered = false;

    // Start timer
    function updateTimer() {
        const elapsed = (Date.now() - startTime) / 1000;
        timerDiv.textContent = elapsed.toFixed(1) + 's';
    }
    timerInterval = setInterval(updateTimer, 100);

    // Focus input on page load
    answerInput.focus();

    // Handle answer submission
    async function submitAnswer() {
        if (answered) {
            loadNextQuestion();
            return;
        }

        const answer = answerInput.value.trim();
        if (!answer) return;

        clearInterval(timerInterval);
        const timeTaken = Date.now() - startTime;

        try {
            const response = await fetch('{% url "trainer:check_answer" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    question_id: questionId,
                    answer: answer,
                    time_taken_ms: timeTaken,
                }),
            });

            const data = await response.json();

            if (data.error) {
                resultDiv.innerHTML = `<span class="incorrect">${data.error}</span>`;
                return;
            }

            answered = true;
            answerInput.disabled = true;
            submitBtn.style.display = 'none';
            nextBtn.style.display = 'inline-block';
            skipBtn.style.display = 'none';

            if (data.correct) {
                resultDiv.innerHTML = '<span class="correct">Correct!</span>';
            } else {
                resultDiv.innerHTML = `<span class="incorrect">Incorrect</span><br>
                    <span style="font-size: 18px; color: #9ca3af;">
                        The answer was ${data.correct_answer}
                    </span>`;
            }

            // Update streak from server response
            streakSpan.textContent = data.current_streak;
            bestStreakSpan.textContent = data.best_streak;

            // Update Leitner box display
            if (data.leitner_box) {
                currentBoxSpan.textContent = data.leitner_box;

                // Update box indicator dots
                document.querySelectorAll('.box-dot').forEach((dot, index) => {
                    dot.classList.remove('active');
                    if (index + 1 === data.leitner_box) {
                        dot.classList.add('active');
                    }
                });

                // Show box change message
                if (data.leitner_box > initialBox) {
                    leitnerResultDiv.innerHTML = `<span class="box-change promoted">Promoted to Box ${data.leitner_box}</span>`;
                } else if (data.leitner_box < initialBox) {
                    leitnerResultDiv.innerHTML = `<span class="box-change demoted">Back to Box ${data.leitner_box}</span>`;
                } else {
                    leitnerResultDiv.innerHTML = `Staying in Box ${data.leitner_box}`;
                }
            }

        } catch (error) {
            resultDiv.innerHTML = `<span class="incorrect">Error checking answer</span>`;
        }
    }

    function loadNextQuestion() {
        const difficulty = difficultySelect.value;
        const operation = operationSelect.value;
        let url = '{% url "trainer:index" %}';
        const params = new URLSearchParams();

        if (difficulty) params.append('difficulty', difficulty);
        if (operation) params.append('operation', operation);

        if (params.toString()) {
            url += '?' + params.toString();
        }

        window.location.href = url;
    }

    // Event listeners
    submitBtn.addEventListener('click', submitAnswer);
    nextBtn.addEventListener('click', loadNextQuestion);
    skipBtn.addEventListener('click', loadNextQuestion);

    answerInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            submitAnswer();
        }
    });

    // Document-level Enter key handler for going to next question after answer is submitted
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && answered) {
            e.preventDefault();
            loadNextQuestion();
        }
    });

    // Filter change handlers
    difficultySelect.addEventListener('change', loadNextQuestion);
    operationSelect.addEventListener('change', loadNextQuestion);
</script>
{% endblock %}
